<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>ser/impl/formatter/details/escape.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-comment">//! JSON escaping-related code.</span></span>
<span class="line" id="L2"><span class="tok-comment">//!</span></span>
<span class="line" id="L3"><span class="tok-comment">//! The escaping rules used in this module originate from Fastly:</span></span>
<span class="line" id="L4"><span class="tok-comment">//! https://developer.fastly.com/reference/vcl/functions/strings/json-escape/.</span></span>
<span class="line" id="L5"><span class="tok-comment">//!</span></span>
<span class="line" id="L6"><span class="tok-comment">//! The rules are as follows (in priority order):</span></span>
<span class="line" id="L7"><span class="tok-comment">//!</span></span>
<span class="line" id="L8"><span class="tok-comment">//!   1. If the code point is the double quote (0x22), it is escaped as \&quot;.</span></span>
<span class="line" id="L9"><span class="tok-comment">//!</span></span>
<span class="line" id="L10"><span class="tok-comment">//!   2. If the code point is the backslash (0x5C), it is escaped as \\.</span></span>
<span class="line" id="L11"><span class="tok-comment">//!</span></span>
<span class="line" id="L12"><span class="tok-comment">//!   3. If the code point is listed below, they are escaped accordingly:</span></span>
<span class="line" id="L13"><span class="tok-comment">//!</span></span>
<span class="line" id="L14"><span class="tok-comment">//!       * 0x08 (backspace)        -&gt;  \b</span></span>
<span class="line" id="L15"><span class="tok-comment">//!       * 0x09 (horizontal tab)   -&gt;  \t</span></span>
<span class="line" id="L16"><span class="tok-comment">//!       * 0x0A (newline)          -&gt;  \n</span></span>
<span class="line" id="L17"><span class="tok-comment">//!       * 0x0C (form feed)        -&gt;  \f</span></span>
<span class="line" id="L18"><span class="tok-comment">//!       * 0x0D (carriage return)  -&gt;  \r</span></span>
<span class="line" id="L19"><span class="tok-comment">//!</span></span>
<span class="line" id="L20"><span class="tok-comment">//!   4. If the code point is less than or equal to 0x1F, or is equal to</span></span>
<span class="line" id="L21"><span class="tok-comment">//!   0x7F, 0x2028, or 0x2029, then it is a control character that wasn't</span></span>
<span class="line" id="L22"><span class="tok-comment">//!   listed above, and is escaped as \uHHHH where 'HHHH' is the hexadecimal</span></span>
<span class="line" id="L23"><span class="tok-comment">//!   value of the code point.</span></span>
<span class="line" id="L24"><span class="tok-comment">//!</span></span>
<span class="line" id="L25"><span class="tok-comment">//!   5. If the code point is greater than 0xFFFF (i.e., it is beyond the Basic</span></span>
<span class="line" id="L26"><span class="tok-comment">//!   Multilingual Plane of Unicode), the code point is converted into a UTF-16</span></span>
<span class="line" id="L27"><span class="tok-comment">//!   surrogate pair with the \\u notation (e.g., U+1F601, or 'üòÅ', would be</span></span>
<span class="line" id="L28"><span class="tok-comment">//!   escaped as \uD83D\uDE01).</span></span>
<span class="line" id="L29"><span class="tok-comment">//!</span></span>
<span class="line" id="L30"><span class="tok-comment">//!   6. If none of the preceding rules match and there is a sequence of</span></span>
<span class="line" id="L31"><span class="tok-comment">//!   valid UTF-8 bytes, the bytes are passed through as-is (e.g., the code</span></span>
<span class="line" id="L32"><span class="tok-comment">//!   point U+0061 would be passed through as 'a').</span></span>
<span class="line" id="L33"><span class="tok-comment">//!</span></span>
<span class="line" id="L34"><span class="tok-comment">//!   7. If there is a byte sequence of invalid UTF-8, the conversion fails.</span></span>
<span class="line" id="L35"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L36"></span>
<span class="line" id="L37"><span class="tok-kw">const</span> DOUBLE_QUOTE = <span class="tok-str">'\&quot;'</span>;</span>
<span class="line" id="L38"><span class="tok-kw">const</span> BACKSLASH = <span class="tok-str">'\\'</span>;</span>
<span class="line" id="L39"><span class="tok-kw">const</span> BACKSPACE = <span class="tok-number">0x08</span>;</span>
<span class="line" id="L40"><span class="tok-kw">const</span> TAB = <span class="tok-str">'\t'</span>;</span>
<span class="line" id="L41"><span class="tok-kw">const</span> NEWLINE = <span class="tok-str">'\n'</span>;</span>
<span class="line" id="L42"><span class="tok-kw">const</span> FORM_FEED = <span class="tok-number">0x0C</span>;</span>
<span class="line" id="L43"><span class="tok-kw">const</span> CARRIAGE_RETURN = <span class="tok-str">'\r'</span>;</span>
<span class="line" id="L44"></span>
<span class="line" id="L45"><span class="tok-kw">const</span> HEX_DIGITS = [_]<span class="tok-type">u8</span>{ <span class="tok-str">'0'</span>, <span class="tok-str">'1'</span>, <span class="tok-str">'2'</span>, <span class="tok-str">'3'</span>, <span class="tok-str">'4'</span>, <span class="tok-str">'5'</span>, <span class="tok-str">'6'</span>, <span class="tok-str">'7'</span>, <span class="tok-str">'8'</span>, <span class="tok-str">'9'</span>, <span class="tok-str">'a'</span>, <span class="tok-str">'b'</span>, <span class="tok-str">'c'</span>, <span class="tok-str">'d'</span>, <span class="tok-str">'e'</span>, <span class="tok-str">'f'</span> };</span>
<span class="line" id="L46"></span>
<span class="line" id="L47"><span class="tok-comment">// ASCII characters that require escaping.</span>
</span>
<span class="line" id="L48"><span class="tok-comment">//</span>
</span>
<span class="line" id="L49"><span class="tok-comment">// The list of ASCII characters that require escaping include: 0x00-0x1F, 0x22</span>
</span>
<span class="line" id="L50"><span class="tok-comment">// (double quote), 0x5C (backslash), and 0x7F.</span>
</span>
<span class="line" id="L51"><span class="tok-kw">const</span> escape_characters_ascii = [_]<span class="tok-type">bool</span>{</span>
<span class="line" id="L52">    <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,</span>
<span class="line" id="L53">    <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,</span>
<span class="line" id="L54">    <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,</span>
<span class="line" id="L55">    <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,  <span class="tok-null">true</span>,</span>
<span class="line" id="L56">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>,  <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L57">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L58">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L59">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L60">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L61">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L62">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L63">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>,  <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L64">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L65">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L66">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L67">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">true</span>,</span>
<span class="line" id="L68">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L69">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L70">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L71">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L72">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L73">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L74">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L75">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L76">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L77">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L78">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L79">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L80">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L81">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L82">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L83">    <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>, <span class="tok-null">false</span>,</span>
<span class="line" id="L84"></span>
<span class="line" id="L85">    <span class="tok-comment">// Ensures that 0xFF is not out of bounds.</span>
</span>
<span class="line" id="L86">    <span class="tok-null">false</span>,</span>
<span class="line" id="L87">};</span>
<span class="line" id="L88"></span>
<span class="line" id="L89"><span class="tok-comment">/// Escapes a UTF-8 encoded code point using JSON escape sequences.</span></span>
<span class="line" id="L90"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">escapeChar</span>(rune: <span class="tok-type">u21</span>, w: <span class="tok-kw">anytype</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L91">    <span class="tok-kw">switch</span> (rune) {</span>
<span class="line" id="L92">        DOUBLE_QUOTE =&gt; <span class="tok-kw">try</span> w.writeAll(<span class="tok-str">&quot;\\\&quot;&quot;</span>),</span>
<span class="line" id="L93">        BACKSLASH =&gt; <span class="tok-kw">try</span> w.writeAll(<span class="tok-str">&quot;\\\\&quot;</span>),</span>
<span class="line" id="L94">        BACKSPACE =&gt; <span class="tok-kw">try</span> w.writeAll(<span class="tok-str">&quot;\\b&quot;</span>),</span>
<span class="line" id="L95">        TAB =&gt; <span class="tok-kw">try</span> w.writeAll(<span class="tok-str">&quot;\\t&quot;</span>),</span>
<span class="line" id="L96">        NEWLINE =&gt; <span class="tok-kw">try</span> w.writeAll(<span class="tok-str">&quot;\\n&quot;</span>),</span>
<span class="line" id="L97">        FORM_FEED =&gt; <span class="tok-kw">try</span> w.writeAll(<span class="tok-str">&quot;\\f&quot;</span>),</span>
<span class="line" id="L98">        CARRIAGE_RETURN =&gt; <span class="tok-kw">try</span> w.writeAll(<span class="tok-str">&quot;\\r&quot;</span>),</span>
<span class="line" id="L99">        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">switch</span> (rune) {</span>
<span class="line" id="L100">            <span class="tok-number">0x00</span>...<span class="tok-number">0x1F</span>, <span class="tok-number">0x7F</span>, <span class="tok-number">0x2028</span>, <span class="tok-number">0x2029</span> =&gt; {</span>
<span class="line" id="L101">                <span class="tok-kw">try</span> w.writeAll(&amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L102">                    <span class="tok-str">'\\'</span>,</span>
<span class="line" id="L103">                    <span class="tok-str">'u'</span>,</span>
<span class="line" id="L104">                    HEX_DIGITS[rune &gt;&gt; <span class="tok-number">12</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L105">                    HEX_DIGITS[rune &gt;&gt; <span class="tok-number">8</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L106">                    HEX_DIGITS[rune &gt;&gt; <span class="tok-number">4</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L107">                    HEX_DIGITS[rune &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L108">                });</span>
<span class="line" id="L109">            },</span>
<span class="line" id="L110">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">if</span> (rune &gt; <span class="tok-number">0xFFFF</span>) {</span>
<span class="line" id="L111">                std.debug.assert(rune &lt;= <span class="tok-number">0x10FFFF</span>);</span>
<span class="line" id="L112"></span>
<span class="line" id="L113">                <span class="tok-kw">const</span> high = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>((rune - <span class="tok-number">0x10000</span>) &gt;&gt; <span class="tok-number">10</span>)) + <span class="tok-number">0xD800</span>;</span>
<span class="line" id="L114">                <span class="tok-kw">const</span> low = <span class="tok-builtin">@as</span>(<span class="tok-type">u16</span>, <span class="tok-builtin">@intCast</span>(rune &amp; <span class="tok-number">0x3FF</span>)) + <span class="tok-number">0xDC00</span>;</span>
<span class="line" id="L115"></span>
<span class="line" id="L116">                <span class="tok-kw">try</span> w.writeAll(&amp;[_]<span class="tok-type">u8</span>{</span>
<span class="line" id="L117">                    <span class="tok-str">'\\'</span>,</span>
<span class="line" id="L118">                    <span class="tok-str">'u'</span>,</span>
<span class="line" id="L119">                    HEX_DIGITS[high &gt;&gt; <span class="tok-number">12</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L120">                    HEX_DIGITS[high &gt;&gt; <span class="tok-number">8</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L121">                    HEX_DIGITS[high &gt;&gt; <span class="tok-number">4</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L122">                    HEX_DIGITS[high &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L123">                    <span class="tok-str">'\\'</span>,</span>
<span class="line" id="L124">                    <span class="tok-str">'u'</span>,</span>
<span class="line" id="L125">                    HEX_DIGITS[low &gt;&gt; <span class="tok-number">12</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L126">                    HEX_DIGITS[low &gt;&gt; <span class="tok-number">8</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L127">                    HEX_DIGITS[low &gt;&gt; <span class="tok-number">4</span> &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L128">                    HEX_DIGITS[low &amp; <span class="tok-number">0xF</span>],</span>
<span class="line" id="L129">                });</span>
<span class="line" id="L130">            } <span class="tok-kw">else</span> {</span>
<span class="line" id="L131">                <span class="tok-builtin">@panic</span>(<span class="tok-str">&quot;Received code point that does not require escaping.&quot;</span>);</span>
<span class="line" id="L132">            },</span>
<span class="line" id="L133">        },</span>
<span class="line" id="L134">    }</span>
<span class="line" id="L135">}</span>
<span class="line" id="L136"></span>
<span class="line" id="L137"><span class="tok-comment">/// Escapes characters of a UTF-8 encoded string using JSON escape sequences.</span></span>
<span class="line" id="L138"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">writeEscaped</span>(bytes: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>, w: <span class="tok-kw">anytype</span>, f: <span class="tok-kw">anytype</span>) !<span class="tok-type">void</span> {</span>
<span class="line" id="L139">    <span class="tok-kw">var</span> i: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L140">    <span class="tok-kw">var</span> start: <span class="tok-type">usize</span> = <span class="tok-number">0</span>;</span>
<span class="line" id="L141"></span>
<span class="line" id="L142">    <span class="tok-kw">while</span> (i &lt; bytes.len) : (i += <span class="tok-number">1</span>) {</span>
<span class="line" id="L143">        <span class="tok-kw">const</span> length = std.unicode.utf8ByteSequenceLength(bytes[i]) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L144"></span>
<span class="line" id="L145">        <span class="tok-comment">// Skip ASCII characters that don't require escaping.</span>
</span>
<span class="line" id="L146">        <span class="tok-kw">if</span> (length == <span class="tok-number">1</span> <span class="tok-kw">and</span> !escape_characters_ascii[bytes[i]]) {</span>
<span class="line" id="L147">            <span class="tok-kw">continue</span>;</span>
<span class="line" id="L148">        }</span>
<span class="line" id="L149"></span>
<span class="line" id="L150">        <span class="tok-kw">const</span> rune = std.unicode.utf8Decode(bytes[i .. i + length]) <span class="tok-kw">catch</span> <span class="tok-kw">unreachable</span>;</span>
<span class="line" id="L151"></span>
<span class="line" id="L152">        <span class="tok-comment">// Skip all other code points that don't require escaping.</span>
</span>
<span class="line" id="L153">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L154">        <span class="tok-comment">// Oddly enough, all attempts to refactor this section have resulted in</span>
</span>
<span class="line" id="L155">        <span class="tok-comment">// lower performance when serializing strings that don't have any</span>
</span>
<span class="line" id="L156">        <span class="tok-comment">// characters that need escaping, and I have no idea why. Additionally,</span>
</span>
<span class="line" id="L157">        <span class="tok-comment">// overall performance is actually lowered even when we don't execute</span>
</span>
<span class="line" id="L158">        <span class="tok-comment">// the refactored versions of this section! Very weird.</span>
</span>
<span class="line" id="L159">        <span class="tok-comment">//</span>
</span>
<span class="line" id="L160">        <span class="tok-comment">// In any case, this switch lets us be faster than std.json, so I guess</span>
</span>
<span class="line" id="L161">        <span class="tok-comment">// it's fine as it is for now.</span>
</span>
<span class="line" id="L162">        <span class="tok-kw">switch</span> (rune) {</span>
<span class="line" id="L163">            <span class="tok-number">0x00</span>...<span class="tok-number">0x1F</span>, DOUBLE_QUOTE, BACKSLASH, <span class="tok-number">0x7F</span>, <span class="tok-number">0x2028</span>, <span class="tok-number">0x2029</span> =&gt; {},</span>
<span class="line" id="L164">            <span class="tok-kw">else</span> =&gt; <span class="tok-kw">if</span> (rune &lt;= <span class="tok-number">0xFFFF</span>) {</span>
<span class="line" id="L165">                i += length - <span class="tok-number">1</span>;</span>
<span class="line" id="L166">                <span class="tok-kw">continue</span>;</span>
<span class="line" id="L167">            },</span>
<span class="line" id="L168">        }</span>
<span class="line" id="L169"></span>
<span class="line" id="L170">        <span class="tok-comment">// Write out any buffered non-escaped code points.</span>
</span>
<span class="line" id="L171">        <span class="tok-kw">if</span> (start &lt; i) {</span>
<span class="line" id="L172">            <span class="tok-kw">try</span> f.writeRawFragment(w, bytes[start..i]);</span>
<span class="line" id="L173">        }</span>
<span class="line" id="L174"></span>
<span class="line" id="L175">        <span class="tok-comment">// Escape and write out the current code point.</span>
</span>
<span class="line" id="L176">        <span class="tok-kw">try</span> f.writeCharEscape(w, rune);</span>
<span class="line" id="L177"></span>
<span class="line" id="L178">        i += length - <span class="tok-number">1</span>;</span>
<span class="line" id="L179">        start = i + <span class="tok-number">1</span>;</span>
<span class="line" id="L180">    }</span>
<span class="line" id="L181"></span>
<span class="line" id="L182">    <span class="tok-comment">// If the input string is suffixed by code points that do not require</span>
</span>
<span class="line" id="L183">    <span class="tok-comment">// escaping, then they've been buffered, but not written. So, we must write</span>
</span>
<span class="line" id="L184">    <span class="tok-comment">// them out.</span>
</span>
<span class="line" id="L185">    <span class="tok-kw">if</span> (start != bytes.len) {</span>
<span class="line" id="L186">        <span class="tok-kw">try</span> f.writeRawFragment(w, bytes[start..]);</span>
<span class="line" id="L187">    }</span>
<span class="line" id="L188">}</span>
<span class="line" id="L189"></span>
</code></pre></body>
</html>