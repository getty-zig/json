<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">    <title>de/deserializer.zig - source view</title>
    <link rel="icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAgklEQVR4AWMYWuD7EllJIM4G4g4g5oIJ/odhOJ8wToOxSTXgNxDHoeiBMfA4+wGShjyYOCkG/IGqWQziEzYAoUAeiF9D5U+DxEg14DRU7jWIT5IBIOdCxf+A+CQZAAoopEB7QJwBCBwHiip8UYmRdrAlDpIMgApwQZNnNii5Dq0MBgCxxycBnwEd+wAAAABJRU5ErkJggg==">
    <link rel="icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxNTMgMTQwIj48ZyBmaWxsPSIjRjdBNDFEIj48Zz48cG9seWdvbiBwb2ludHM9IjQ2LDIyIDI4LDQ0IDE5LDMwIi8+PHBvbHlnb24gcG9pbnRzPSI0NiwyMiAzMywzMyAyOCw0NCAyMiw0NCAyMiw5NSAzMSw5NSAyMCwxMDAgMTIsMTE3IDAsMTE3IDAsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMzEsOTUgMTIsMTE3IDQsMTA2Ii8+PC9nPjxnPjxwb2x5Z29uIHBvaW50cz0iNTYsMjIgNjIsMzYgMzcsNDQiLz48cG9seWdvbiBwb2ludHM9IjU2LDIyIDExMSwyMiAxMTEsNDQgMzcsNDQgNTYsMzIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTE2LDk1IDk3LDExNyA5MCwxMDQiLz48cG9seWdvbiBwb2ludHM9IjExNiw5NSAxMDAsMTA0IDk3LDExNyA0MiwxMTcgNDIsOTUiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTUwLDAgNTIsMTE3IDMsMTQwIDEwMSwyMiIvPjwvZz48Zz48cG9seWdvbiBwb2ludHM9IjE0MSwyMiAxNDAsNDAgMTIyLDQ1Ii8+PHBvbHlnb24gcG9pbnRzPSIxNTMsMjIgMTUzLDExNyAxMDYsMTE3IDEyMCwxMDUgMTI1LDk1IDEzMSw5NSAxMzEsNDUgMTIyLDQ1IDEzMiwzNiAxNDEsMjIiIHNoYXBlLXJlbmRlcmluZz0iY3Jpc3BFZGdlcyIvPjxwb2x5Z29uIHBvaW50cz0iMTI1LDk1IDEzMCwxMTAgMTA2LDExNyIvPjwvZz48L2c+PC9zdmc+">
    <style>
      body{
        font-family: system-ui, -apple-system, Roboto, "Segoe UI", sans-serif;
        margin: 0;
        line-height: 1.5;
      }

      pre > code {
        display: block;
        overflow: auto;
        line-height: normal;
        margin: 0em;
      }
      .tok-kw {
          color: #333;
          font-weight: bold;
      }
      .tok-str {
          color: #d14;
      }
      .tok-builtin {
          color: #005C7A;
      }
      .tok-comment {
          color: #545454;
          font-style: italic;
      }
      .tok-fn {
          color: #900;
          font-weight: bold;
      }
      .tok-null {
          color: #005C5C;
      }
      .tok-number {
          color: #005C5C;
      }
      .tok-type {
          color: #458;
          font-weight: bold;
      }
      pre {
        counter-reset: line;
      }
      pre .line:before {
        counter-increment: line;
        content: counter(line);
        display: inline-block;
        padding-right: 1em;
        width: 2em;
        text-align: right;
        color: #999;
      }
      
      .line {
        width: 100%;
        display: inline-block;
      }
      .line:target {
        border-top: 1px solid #ccc;
        border-bottom: 1px solid #ccc;
        background: #fafafa;
      }

      @media (prefers-color-scheme: dark) {
        body{
            background:#222;
            color: #ccc;
        }
        pre > code {
            color: #ccc;
            background: #222;
            border: unset;
        }
        .line:target {
            border-top: 1px solid #444;
            border-bottom: 1px solid #444;
            background: #333;
        }
        .tok-kw {
            color: #eee;
        }
        .tok-str {
            color: #2e5;
        }
        .tok-builtin {
            color: #ff894c;
        }
        .tok-comment {
            color: #aa7;
        }
        .tok-fn {
            color: #B1A0F8;
        }
        .tok-null {
            color: #ff8080;
        }
        .tok-number {
            color: #ff8080;
        }
        .tok-type {
            color: #68f;
        }
      }
    </style>
</head>
<body>
<pre><code><span class="line" id="L1"><span class="tok-kw">const</span> getty = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;getty&quot;</span>);</span>
<span class="line" id="L2"><span class="tok-kw">const</span> std = <span class="tok-builtin">@import</span>(<span class="tok-str">&quot;std&quot;</span>);</span>
<span class="line" id="L3"></span>
<span class="line" id="L4"><span class="tok-kw">const</span> Allocator = std.mem.Allocator;</span>
<span class="line" id="L5"></span>
<span class="line" id="L6"><span class="tok-comment">/// A JSON Deserializer.</span></span>
<span class="line" id="L7"><span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">Deserializer</span>(<span class="tok-kw">comptime</span> dbt: <span class="tok-kw">anytype</span>, <span class="tok-kw">comptime</span> Reader: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L8">    <span class="tok-kw">const</span> Parser = std.json.Reader(std.json.default_buffer_size, Reader);</span>
<span class="line" id="L9"></span>
<span class="line" id="L10">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L11">        parser: Parser,</span>
<span class="line" id="L12">        scratch: std.heap.ArenaAllocator,</span>
<span class="line" id="L13"></span>
<span class="line" id="L14">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L15"></span>
<span class="line" id="L16">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">init</span>(ally: Allocator, r: Reader) Self {</span>
<span class="line" id="L17">            <span class="tok-kw">return</span> Self{</span>
<span class="line" id="L18">                .parser = std.json.reader(ally, r),</span>
<span class="line" id="L19">                .scratch = std.heap.ArenaAllocator.init(ally),</span>
<span class="line" id="L20">            };</span>
<span class="line" id="L21">        }</span>
<span class="line" id="L22"></span>
<span class="line" id="L23">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">deinit</span>(self: *Self) <span class="tok-type">void</span> {</span>
<span class="line" id="L24">            self.parser.deinit();</span>
<span class="line" id="L25">            self.scratch.deinit();</span>
<span class="line" id="L26">            self.* = <span class="tok-null">undefined</span>;</span>
<span class="line" id="L27">        }</span>
<span class="line" id="L28"></span>
<span class="line" id="L29">        <span class="tok-comment">/// Validates that the input data has been fully deserialized.</span></span>
<span class="line" id="L30">        <span class="tok-comment">///</span></span>
<span class="line" id="L31">        <span class="tok-comment">/// This method should always be called after a value has been fully</span></span>
<span class="line" id="L32">        <span class="tok-comment">/// deserialized.</span></span>
<span class="line" id="L33">        <span class="tok-kw">pub</span> <span class="tok-kw">fn</span> <span class="tok-fn">end</span>(self: *Self) Err!<span class="tok-type">void</span> {</span>
<span class="line" id="L34">            <span class="tok-kw">if</span> (<span class="tok-kw">try</span> self.parser.next() != .end_of_document) {</span>
<span class="line" id="L35">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SyntaxError;</span>
<span class="line" id="L36">            }</span>
<span class="line" id="L37">        }</span>
<span class="line" id="L38"></span>
<span class="line" id="L39">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> getty.Deserializer(</span>
<span class="line" id="L40">            *Self,</span>
<span class="line" id="L41">            Err,</span>
<span class="line" id="L42">            dbt,</span>
<span class="line" id="L43">            <span class="tok-null">null</span>,</span>
<span class="line" id="L44">            .{</span>
<span class="line" id="L45">                .deserializeAny = deserializeAny,</span>
<span class="line" id="L46">                .deserializeBool = deserializeBool,</span>
<span class="line" id="L47">                .deserializeEnum = deserializeEnum,</span>
<span class="line" id="L48">                .deserializeFloat = deserializeFloat,</span>
<span class="line" id="L49">                .deserializeIgnored = deserializeIgnored,</span>
<span class="line" id="L50">                .deserializeInt = deserializeInt,</span>
<span class="line" id="L51">                .deserializeMap = deserializeMap,</span>
<span class="line" id="L52">                .deserializeOptional = deserializeOptional,</span>
<span class="line" id="L53">                .deserializeSeq = deserializeSeq,</span>
<span class="line" id="L54">                .deserializeString = deserializeString,</span>
<span class="line" id="L55">                .deserializeStruct = deserializeStruct,</span>
<span class="line" id="L56">                .deserializeUnion = deserializeUnion,</span>
<span class="line" id="L57">                .deserializeVoid = deserializeVoid,</span>
<span class="line" id="L58">            },</span>
<span class="line" id="L59">        );</span>
<span class="line" id="L60"></span>
<span class="line" id="L61">        <span class="tok-kw">const</span> De = Self.@&quot;getty.Deserializer&quot;;</span>
<span class="line" id="L62">        <span class="tok-kw">const</span> Err = getty.de.Error ||</span>
<span class="line" id="L63">            <span class="tok-comment">// This includes all of std.json.Reader's errors, including</span>
</span>
<span class="line" id="L64">            <span class="tok-comment">// std.json.Error.</span>
</span>
<span class="line" id="L65">            Parser.AllocError ||</span>
<span class="line" id="L66">            std.fmt.ParseIntError || std.fmt.ParseFloatError;</span>
<span class="line" id="L67"></span>
<span class="line" id="L68">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeBool</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L69">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.next()) {</span>
<span class="line" id="L70">                .<span class="tok-null">true</span> =&gt; <span class="tok-kw">try</span> visitor.visitBool(arena, De, <span class="tok-null">true</span>),</span>
<span class="line" id="L71">                .<span class="tok-null">false</span> =&gt; <span class="tok-kw">try</span> visitor.visitBool(arena, De, <span class="tok-null">false</span>),</span>
<span class="line" id="L72">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L73">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L74">            };</span>
<span class="line" id="L75">        }</span>
<span class="line" id="L76"></span>
<span class="line" id="L77">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeEnum</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L78">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.nextAlloc(self.scratch.allocator(), .alloc_if_needed)) {</span>
<span class="line" id="L79">                .string, .allocated_string =&gt; |slice| (<span class="tok-kw">try</span> visitor.visitString(arena, De, slice, .managed)).value,</span>
<span class="line" id="L80">                .number, .allocated_number =&gt; |slice| <span class="tok-kw">try</span> visitInt(visitor, arena, De, slice),</span>
<span class="line" id="L81">                .end_of_document =&gt; <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L82">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L83">            };</span>
<span class="line" id="L84">        }</span>
<span class="line" id="L85"></span>
<span class="line" id="L86">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeFloat</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L87">            <span class="tok-comment">// By default, JSON numbers are deserialized into f128 Getty</span>
</span>
<span class="line" id="L88">            <span class="tok-comment">// Floats. However, std.fmt.parseFloat uses an optimized parsing</span>
</span>
<span class="line" id="L89">            <span class="tok-comment">// algorithm for f16, f32, and f64 values, so we try to use those</span>
</span>
<span class="line" id="L90">            <span class="tok-comment">// wherever we can.</span>
</span>
<span class="line" id="L91">            <span class="tok-kw">const</span> Float = <span class="tok-kw">switch</span> (<span class="tok-builtin">@TypeOf</span>(visitor).Value) {</span>
<span class="line" id="L92">                <span class="tok-type">f16</span>, <span class="tok-type">f32</span>, <span class="tok-type">f64</span> =&gt; |T| T,</span>
<span class="line" id="L93">                <span class="tok-kw">else</span> =&gt; <span class="tok-type">f128</span>,</span>
<span class="line" id="L94">            };</span>
<span class="line" id="L95"></span>
<span class="line" id="L96">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.nextAlloc(self.scratch.allocator(), .alloc_if_needed)) {</span>
<span class="line" id="L97">                .number, .allocated_number =&gt; |slice| <span class="tok-kw">try</span> visitor.visitFloat(arena, De, <span class="tok-kw">try</span> std.fmt.parseFloat(Float, slice)),</span>
<span class="line" id="L98">                .end_of_document =&gt; <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L99">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L100">            };</span>
<span class="line" id="L101">        }</span>
<span class="line" id="L102"></span>
<span class="line" id="L103">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeIgnored</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L104">            <span class="tok-kw">try</span> self.parser.skipValue();</span>
<span class="line" id="L105">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitVoid(arena, De);</span>
<span class="line" id="L106">        }</span>
<span class="line" id="L107"></span>
<span class="line" id="L108">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeInt</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L109">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.nextAlloc(self.scratch.allocator(), .alloc_if_needed)) {</span>
<span class="line" id="L110">                .number, .allocated_number =&gt; |slice| <span class="tok-kw">try</span> visitInt(visitor, arena, De, slice),</span>
<span class="line" id="L111">                .string, .allocated_string =&gt; |slice| (<span class="tok-kw">try</span> visitor.visitString(arena, De, slice, .managed)).value,</span>
<span class="line" id="L112">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L113">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L114">            };</span>
<span class="line" id="L115">        }</span>
<span class="line" id="L116"></span>
<span class="line" id="L117">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeMap</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L118">            <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.next()) {</span>
<span class="line" id="L119">                .object_begin =&gt; {</span>
<span class="line" id="L120">                    <span class="tok-kw">var</span> m = MapAccess(Self){ .d = self };</span>
<span class="line" id="L121">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitMap(arena, De, m.mapAccess());</span>
<span class="line" id="L122">                },</span>
<span class="line" id="L123">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L124">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L125">            }</span>
<span class="line" id="L126">        }</span>
<span class="line" id="L127"></span>
<span class="line" id="L128">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeOptional</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L129">            <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.peekNextTokenType()) {</span>
<span class="line" id="L130">                .<span class="tok-null">null</span> =&gt; {</span>
<span class="line" id="L131">                    <span class="tok-kw">try</span> self.skipToken(); <span class="tok-comment">// Eat 'null'.</span>
</span>
<span class="line" id="L132">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitNull(arena, De);</span>
<span class="line" id="L133">                },</span>
<span class="line" id="L134">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L135">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitSome(arena, self.deserializer()),</span>
<span class="line" id="L136">            }</span>
<span class="line" id="L137">        }</span>
<span class="line" id="L138"></span>
<span class="line" id="L139">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeSeq</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L140">            <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.next()) {</span>
<span class="line" id="L141">                .array_begin =&gt; {</span>
<span class="line" id="L142">                    <span class="tok-kw">var</span> s = SeqAccess(Self){ .d = self };</span>
<span class="line" id="L143">                    <span class="tok-kw">const</span> ret = <span class="tok-kw">try</span> visitor.visitSeq(arena, De, s.seqAccess());</span>
<span class="line" id="L144">                    <span class="tok-kw">try</span> self.endSeq(); <span class="tok-comment">// Eat ']'.</span>
</span>
<span class="line" id="L145">                    <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L146">                },</span>
<span class="line" id="L147">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L148">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L149">            }</span>
<span class="line" id="L150">        }</span>
<span class="line" id="L151"></span>
<span class="line" id="L152">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeString</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L153">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.nextAlloc(arena, .alloc_always)) {</span>
<span class="line" id="L154">                .allocated_string =&gt; |slice| (<span class="tok-kw">try</span> visitor.visitString(arena, De, slice, .heap)).value,</span>
<span class="line" id="L155">                .end_of_document =&gt; <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L156">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L157">            };</span>
<span class="line" id="L158">        }</span>
<span class="line" id="L159"></span>
<span class="line" id="L160">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeStruct</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L161">            <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.next()) {</span>
<span class="line" id="L162">                .object_begin =&gt; {</span>
<span class="line" id="L163">                    <span class="tok-kw">var</span> s = StructAccess(Self){ .d = self };</span>
<span class="line" id="L164">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitMap(arena, De, s.mapAccess());</span>
<span class="line" id="L165">                },</span>
<span class="line" id="L166">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L167">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L168">            }</span>
<span class="line" id="L169">        }</span>
<span class="line" id="L170"></span>
<span class="line" id="L171">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeUnion</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L172">            <span class="tok-kw">const</span> peek = <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.peekNextTokenType()) {</span>
<span class="line" id="L173">                .object_begin =&gt; |tok| peek: {</span>
<span class="line" id="L174">                    <span class="tok-kw">try</span> self.skipToken(); <span class="tok-comment">// Eat '{'.</span>
</span>
<span class="line" id="L175">                    <span class="tok-kw">break</span> :peek tok;</span>
<span class="line" id="L176">                },</span>
<span class="line" id="L177">                .string =&gt; |tok| tok,</span>
<span class="line" id="L178">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L179">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L180">            };</span>
<span class="line" id="L181"></span>
<span class="line" id="L182">            <span class="tok-kw">var</span> u = UnionAccess(Self){ .d = self };</span>
<span class="line" id="L183">            <span class="tok-kw">const</span> ret = <span class="tok-kw">try</span> visitor.visitUnion(arena, De, u.unionAccess(), u.variantAccess());</span>
<span class="line" id="L184"></span>
<span class="line" id="L185">            <span class="tok-kw">if</span> (peek == .object_begin) {</span>
<span class="line" id="L186">                <span class="tok-kw">try</span> self.endUnion();</span>
<span class="line" id="L187">            }</span>
<span class="line" id="L188"></span>
<span class="line" id="L189">            <span class="tok-kw">return</span> ret;</span>
<span class="line" id="L190">        }</span>
<span class="line" id="L191"></span>
<span class="line" id="L192">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeVoid</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L193">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.next()) {</span>
<span class="line" id="L194">                .<span class="tok-null">null</span> =&gt; <span class="tok-kw">try</span> visitor.visitVoid(arena, De),</span>
<span class="line" id="L195">                .end_of_document =&gt; <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L196">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L197">            };</span>
<span class="line" id="L198">        }</span>
<span class="line" id="L199"></span>
<span class="line" id="L200">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeAny</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L201">            <span class="tok-kw">const</span> Visitor = <span class="tok-builtin">@TypeOf</span>(visitor);</span>
<span class="line" id="L202">            <span class="tok-kw">const</span> visitor_info = <span class="tok-builtin">@typeInfo</span>(Visitor);</span>
<span class="line" id="L203"></span>
<span class="line" id="L204">            <span class="tok-kw">const</span> token = <span class="tok-kw">try</span> self.parser.nextAlloc(arena, .alloc_if_needed);</span>
<span class="line" id="L205"></span>
<span class="line" id="L206">            <span class="tok-kw">switch</span> (token) {</span>
<span class="line" id="L207">                .<span class="tok-null">true</span>, .<span class="tok-null">false</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitBool(arena, De, token == .<span class="tok-null">true</span>),</span>
<span class="line" id="L208">                .number, .allocated_number =&gt; |slice| {</span>
<span class="line" id="L209">                    <span class="tok-kw">if</span> (visitor_info == .Int) {</span>
<span class="line" id="L210">                        <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitIntHint(visitor, arena, De, slice);</span>
<span class="line" id="L211">                    }</span>
<span class="line" id="L212"></span>
<span class="line" id="L213">                    <span class="tok-kw">if</span> (!std.json.isNumberFormattedLikeAnInteger(slice)) {</span>
<span class="line" id="L214">                        <span class="tok-kw">const</span> Float = <span class="tok-kw">switch</span> (Visitor.Value) {</span>
<span class="line" id="L215">                            <span class="tok-type">f16</span>, <span class="tok-type">f32</span>, <span class="tok-type">f64</span> =&gt; |T| T,</span>
<span class="line" id="L216">                            <span class="tok-kw">else</span> =&gt; <span class="tok-type">f128</span>,</span>
<span class="line" id="L217">                        };</span>
<span class="line" id="L218"></span>
<span class="line" id="L219">                        <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitFloat(arena, De, <span class="tok-kw">try</span> std.fmt.parseFloat(Float, slice));</span>
<span class="line" id="L220">                    }</span>
<span class="line" id="L221"></span>
<span class="line" id="L222">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitIntBase(visitor, arena, De, slice);</span>
<span class="line" id="L223">                },</span>
<span class="line" id="L224">                <span class="tok-kw">inline</span> .string, .allocated_string =&gt; |slice| {</span>
<span class="line" id="L225">                    <span class="tok-comment">// Union</span>
</span>
<span class="line" id="L226">                    <span class="tok-kw">if</span> (visitor_info == .Union) {</span>
<span class="line" id="L227">                        <span class="tok-kw">var</span> u = UnionAccess(Self){ .d = self };</span>
<span class="line" id="L228">                        <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitUnion(arena, De, u.unionAccess(), u.variantAccess());</span>
<span class="line" id="L229">                    }</span>
<span class="line" id="L230"></span>
<span class="line" id="L231">                    <span class="tok-comment">// Enum, String</span>
</span>
<span class="line" id="L232">                    <span class="tok-kw">switch</span> (token) {</span>
<span class="line" id="L233">                        .string =&gt; {</span>
<span class="line" id="L234">                            <span class="tok-kw">const</span> ret = <span class="tok-kw">try</span> visitor.visitString(arena, De, slice, .stack);</span>
<span class="line" id="L235">                            std.debug.assert(!ret.used);</span>
<span class="line" id="L236">                            <span class="tok-kw">return</span> ret.value;</span>
<span class="line" id="L237">                        },</span>
<span class="line" id="L238">                        .allocated_string =&gt; {</span>
<span class="line" id="L239">                            <span class="tok-kw">const</span> ret = <span class="tok-kw">try</span> visitor.visitString(arena, De, slice, .heap);</span>
<span class="line" id="L240">                            <span class="tok-kw">if</span> (!ret.used) arena.free(slice);</span>
<span class="line" id="L241">                            <span class="tok-kw">return</span> ret.value;</span>
<span class="line" id="L242">                        },</span>
<span class="line" id="L243">                        <span class="tok-comment">// UNREACHABLE: The outer switch guarantees that only</span>
</span>
<span class="line" id="L244">                        <span class="tok-comment">// .string and .allocated_string tokens will reach this</span>
</span>
<span class="line" id="L245">                        <span class="tok-comment">// inner switch.</span>
</span>
<span class="line" id="L246">                        <span class="tok-kw">else</span> =&gt; <span class="tok-kw">unreachable</span>,</span>
<span class="line" id="L247">                    }</span>
<span class="line" id="L248">                },</span>
<span class="line" id="L249">                .<span class="tok-null">null</span> =&gt; {</span>
<span class="line" id="L250">                    <span class="tok-comment">// Void</span>
</span>
<span class="line" id="L251">                    <span class="tok-kw">if</span> (Visitor.Value == <span class="tok-type">void</span>) {</span>
<span class="line" id="L252">                        <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitVoid(arena, De);</span>
<span class="line" id="L253">                    }</span>
<span class="line" id="L254"></span>
<span class="line" id="L255">                    <span class="tok-comment">// Optional</span>
</span>
<span class="line" id="L256">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitNull(arena, De);</span>
<span class="line" id="L257">                },</span>
<span class="line" id="L258">                .array_begin =&gt; {</span>
<span class="line" id="L259">                    <span class="tok-kw">var</span> s = SeqAccess(Self){ .d = self };</span>
<span class="line" id="L260">                    <span class="tok-kw">const</span> result = <span class="tok-kw">try</span> visitor.visitSeq(arena, De, s.seqAccess());</span>
<span class="line" id="L261"></span>
<span class="line" id="L262">                    <span class="tok-kw">try</span> self.endSeq();</span>
<span class="line" id="L263"></span>
<span class="line" id="L264">                    <span class="tok-kw">return</span> result;</span>
<span class="line" id="L265">                },</span>
<span class="line" id="L266">                .object_begin =&gt; {</span>
<span class="line" id="L267">                    <span class="tok-comment">// Union</span>
</span>
<span class="line" id="L268">                    <span class="tok-kw">if</span> (visitor_info == .Union) {</span>
<span class="line" id="L269">                        <span class="tok-kw">var</span> u = UnionAccess(Self){ .d = self };</span>
<span class="line" id="L270">                        <span class="tok-kw">const</span> result = <span class="tok-kw">try</span> visitor.visitUnion(arena, De, u.unionAccess(), u.variantAccess());</span>
<span class="line" id="L271"></span>
<span class="line" id="L272">                        <span class="tok-kw">try</span> self.endUnion();</span>
<span class="line" id="L273"></span>
<span class="line" id="L274">                        <span class="tok-kw">return</span> result;</span>
<span class="line" id="L275">                    }</span>
<span class="line" id="L276"></span>
<span class="line" id="L277">                    <span class="tok-comment">// Map</span>
</span>
<span class="line" id="L278">                    <span class="tok-kw">var</span> m = MapAccess(Self){ .d = self };</span>
<span class="line" id="L279">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitMap(arena, De, m.mapAccess());</span>
<span class="line" id="L280">                },</span>
<span class="line" id="L281">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L282">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L283">            }</span>
<span class="line" id="L284">        }</span>
<span class="line" id="L285"></span>
<span class="line" id="L286">        <span class="tok-kw">fn</span> <span class="tok-fn">skipToken</span>(self: *Self) !<span class="tok-type">void</span> {</span>
<span class="line" id="L287">            <span class="tok-kw">while</span> (<span class="tok-null">true</span>) {</span>
<span class="line" id="L288">                <span class="tok-kw">const</span> token = <span class="tok-kw">try</span> self.parser.next();</span>
<span class="line" id="L289"></span>
<span class="line" id="L290">                <span class="tok-kw">switch</span> (token) {</span>
<span class="line" id="L291">                    .partial_number,</span>
<span class="line" id="L292">                    .partial_string,</span>
<span class="line" id="L293">                    .partial_string_escaped_1,</span>
<span class="line" id="L294">                    .partial_string_escaped_2,</span>
<span class="line" id="L295">                    .partial_string_escaped_3,</span>
<span class="line" id="L296">                    .partial_string_escaped_4,</span>
<span class="line" id="L297">                    =&gt; {},</span>
<span class="line" id="L298">                    <span class="tok-kw">else</span> =&gt; <span class="tok-kw">break</span>,</span>
<span class="line" id="L299">                }</span>
<span class="line" id="L300">            }</span>
<span class="line" id="L301">        }</span>
<span class="line" id="L302"></span>
<span class="line" id="L303">        <span class="tok-kw">fn</span> <span class="tok-fn">endSeq</span>(self: *Self) Err!<span class="tok-type">void</span> {</span>
<span class="line" id="L304">            <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.peekNextTokenType()) {</span>
<span class="line" id="L305">                .array_end =&gt; <span class="tok-kw">try</span> self.skipToken(), <span class="tok-comment">// Eat ']'.</span>
</span>
<span class="line" id="L306">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L307">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SyntaxError,</span>
<span class="line" id="L308">            }</span>
<span class="line" id="L309">        }</span>
<span class="line" id="L310"></span>
<span class="line" id="L311">        <span class="tok-kw">fn</span> <span class="tok-fn">endUnion</span>(self: *Self) Err!<span class="tok-type">void</span> {</span>
<span class="line" id="L312">            <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.parser.peekNextTokenType()) {</span>
<span class="line" id="L313">                .object_end =&gt; <span class="tok-kw">try</span> self.skipToken(), <span class="tok-comment">// Eat '}'.</span>
</span>
<span class="line" id="L314">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L315">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.SyntaxError,</span>
<span class="line" id="L316">            }</span>
<span class="line" id="L317">        }</span>
<span class="line" id="L318">    };</span>
<span class="line" id="L319">}</span>
<span class="line" id="L320"></span>
<span class="line" id="L321"><span class="tok-kw">fn</span> <span class="tok-fn">MapKeyDeserializer</span>(<span class="tok-kw">comptime</span> De: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L322">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L323">        key: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L324">        allocated: <span class="tok-type">bool</span>,</span>
<span class="line" id="L325"></span>
<span class="line" id="L326">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L327"></span>
<span class="line" id="L328">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> getty.Deserializer(</span>
<span class="line" id="L329">            *Self,</span>
<span class="line" id="L330">            Err,</span>
<span class="line" id="L331">            De.user_dt,</span>
<span class="line" id="L332">            De.deserializer_dt,</span>
<span class="line" id="L333">            .{</span>
<span class="line" id="L334">                .deserializeAny = deserializeAny,</span>
<span class="line" id="L335">                .deserializeIgnored = deserializeIgnored,</span>
<span class="line" id="L336">                .deserializeInt = deserializeInt,</span>
<span class="line" id="L337">                .deserializeString = deserializeString,</span>
<span class="line" id="L338">            },</span>
<span class="line" id="L339">        );</span>
<span class="line" id="L340"></span>
<span class="line" id="L341">        <span class="tok-kw">const</span> Err = De.Err;</span>
<span class="line" id="L342"></span>
<span class="line" id="L343">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeAny</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L344">            <span class="tok-kw">const</span> Value = <span class="tok-builtin">@TypeOf</span>(visitor).Value;</span>
<span class="line" id="L345"></span>
<span class="line" id="L346">            <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(Value) == .Int) {</span>
<span class="line" id="L347">                <span class="tok-kw">return</span> <span class="tok-kw">try</span> self.deserializeInt(arena, visitor);</span>
<span class="line" id="L348">            }</span>
<span class="line" id="L349"></span>
<span class="line" id="L350">            <span class="tok-kw">if</span> (<span class="tok-kw">comptime</span> isString(Value)) {</span>
<span class="line" id="L351">                <span class="tok-kw">return</span> <span class="tok-kw">try</span> self.deserializeString(arena, visitor);</span>
<span class="line" id="L352">            }</span>
<span class="line" id="L353"></span>
<span class="line" id="L354">            <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType;</span>
<span class="line" id="L355">        }</span>
<span class="line" id="L356"></span>
<span class="line" id="L357">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeIgnored</span>(_: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L358">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitVoid(arena, De);</span>
<span class="line" id="L359">        }</span>
<span class="line" id="L360"></span>
<span class="line" id="L361">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeInt</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L362">            <span class="tok-kw">if</span> (self.key.len == <span class="tok-number">0</span>) {</span>
<span class="line" id="L363">                <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidValue;</span>
<span class="line" id="L364">            }</span>
<span class="line" id="L365"></span>
<span class="line" id="L366">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitInt(visitor, arena, De, self.key);</span>
<span class="line" id="L367">        }</span>
<span class="line" id="L368"></span>
<span class="line" id="L369">        <span class="tok-kw">fn</span> <span class="tok-fn">deserializeString</span>(self: *Self, arena: Allocator, visitor: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L370">            <span class="tok-kw">if</span> (self.allocated) {</span>
<span class="line" id="L371">                <span class="tok-kw">const</span> ret = <span class="tok-kw">try</span> visitor.visitString(arena, De, self.key, .heap);</span>
<span class="line" id="L372">                <span class="tok-kw">if</span> (!ret.used) arena.free(self.key);</span>
<span class="line" id="L373">                <span class="tok-kw">return</span> ret.value;</span>
<span class="line" id="L374">            }</span>
<span class="line" id="L375"></span>
<span class="line" id="L376">            <span class="tok-kw">const</span> ret = <span class="tok-kw">try</span> visitor.visitString(arena, De, self.key, .stack);</span>
<span class="line" id="L377">            std.debug.assert(!ret.used);</span>
<span class="line" id="L378">            <span class="tok-kw">return</span> ret.value;</span>
<span class="line" id="L379">        }</span>
<span class="line" id="L380">    };</span>
<span class="line" id="L381">}</span>
<span class="line" id="L382"></span>
<span class="line" id="L383"><span class="tok-kw">fn</span> <span class="tok-fn">MapAccess</span>(<span class="tok-kw">comptime</span> D: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L384">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L385">        d: *D,</span>
<span class="line" id="L386"></span>
<span class="line" id="L387">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L388"></span>
<span class="line" id="L389">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> getty.de.MapAccess(</span>
<span class="line" id="L390">            *Self,</span>
<span class="line" id="L391">            Err,</span>
<span class="line" id="L392">            .{</span>
<span class="line" id="L393">                .nextKeySeed = nextKeySeed,</span>
<span class="line" id="L394">                .nextValueSeed = nextValueSeed,</span>
<span class="line" id="L395">            },</span>
<span class="line" id="L396">        );</span>
<span class="line" id="L397"></span>
<span class="line" id="L398">        <span class="tok-kw">const</span> De = D.@&quot;getty.Deserializer&quot;;</span>
<span class="line" id="L399">        <span class="tok-kw">const</span> Err = De.Err;</span>
<span class="line" id="L400"></span>
<span class="line" id="L401">        <span class="tok-kw">fn</span> <span class="tok-fn">nextKeySeed</span>(self: *Self, arena: Allocator, seed: <span class="tok-kw">anytype</span>) Err!?<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L402">            <span class="tok-kw">const</span> token = <span class="tok-kw">try</span> self.d.parser.nextAlloc(arena, .alloc_if_needed);</span>
<span class="line" id="L403">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (token) {</span>
<span class="line" id="L404">                .string, .allocated_string =&gt; |slice| {</span>
<span class="line" id="L405">                    <span class="tok-kw">const</span> allocated = token == .allocated_string;</span>
<span class="line" id="L406">                    <span class="tok-kw">var</span> mkd = MapKeyDeserializer(De){ .key = slice, .allocated = allocated };</span>
<span class="line" id="L407">                    <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(arena, mkd.deserializer());</span>
<span class="line" id="L408">                },</span>
<span class="line" id="L409">                .object_end =&gt; <span class="tok-null">null</span>,</span>
<span class="line" id="L410">                .end_of_document =&gt; <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L411">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L412">            };</span>
<span class="line" id="L413">        }</span>
<span class="line" id="L414"></span>
<span class="line" id="L415">        <span class="tok-kw">fn</span> <span class="tok-fn">nextValueSeed</span>(self: *Self, arena: Allocator, seed: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L416">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(arena, self.d.deserializer());</span>
<span class="line" id="L417">        }</span>
<span class="line" id="L418">    };</span>
<span class="line" id="L419">}</span>
<span class="line" id="L420"></span>
<span class="line" id="L421"><span class="tok-kw">fn</span> <span class="tok-fn">SeqAccess</span>(<span class="tok-kw">comptime</span> D: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L422">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L423">        d: *D,</span>
<span class="line" id="L424"></span>
<span class="line" id="L425">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L426"></span>
<span class="line" id="L427">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> getty.de.SeqAccess(</span>
<span class="line" id="L428">            *Self,</span>
<span class="line" id="L429">            Err,</span>
<span class="line" id="L430">            .{ .nextElementSeed = nextElementSeed },</span>
<span class="line" id="L431">        );</span>
<span class="line" id="L432"></span>
<span class="line" id="L433">        <span class="tok-kw">const</span> De = D.@&quot;getty.Deserializer&quot;;</span>
<span class="line" id="L434">        <span class="tok-kw">const</span> Err = De.Err;</span>
<span class="line" id="L435"></span>
<span class="line" id="L436">        <span class="tok-kw">fn</span> <span class="tok-fn">nextElementSeed</span>(self: *Self, arena: Allocator, seed: <span class="tok-kw">anytype</span>) Err!?<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L437">            <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.d.parser.peekNextTokenType()) {</span>
<span class="line" id="L438">                .array_end =&gt; <span class="tok-kw">return</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L439">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L440">                <span class="tok-kw">else</span> =&gt; {},</span>
<span class="line" id="L441">            }</span>
<span class="line" id="L442"></span>
<span class="line" id="L443">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(arena, self.d.deserializer());</span>
<span class="line" id="L444">        }</span>
<span class="line" id="L445">    };</span>
<span class="line" id="L446">}</span>
<span class="line" id="L447"></span>
<span class="line" id="L448"><span class="tok-kw">fn</span> <span class="tok-fn">StructAccess</span>(<span class="tok-kw">comptime</span> D: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L449">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L450">        d: *D,</span>
<span class="line" id="L451"></span>
<span class="line" id="L452">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L453"></span>
<span class="line" id="L454">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> getty.de.MapAccess(</span>
<span class="line" id="L455">            *Self,</span>
<span class="line" id="L456">            Err,</span>
<span class="line" id="L457">            .{</span>
<span class="line" id="L458">                .nextKeySeed = nextKeySeed,</span>
<span class="line" id="L459">                .nextValueSeed = nextValueSeed,</span>
<span class="line" id="L460">            },</span>
<span class="line" id="L461">        );</span>
<span class="line" id="L462"></span>
<span class="line" id="L463">        <span class="tok-kw">const</span> De = D.@&quot;getty.Deserializer&quot;;</span>
<span class="line" id="L464">        <span class="tok-kw">const</span> Err = De.Err;</span>
<span class="line" id="L465"></span>
<span class="line" id="L466">        <span class="tok-kw">fn</span> <span class="tok-fn">nextKeySeed</span>(self: *Self, _: Allocator, seed: <span class="tok-kw">anytype</span>) Err!?<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L467">            <span class="tok-kw">if</span> (<span class="tok-builtin">@TypeOf</span>(seed).Value != []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) {</span>
<span class="line" id="L468">                <span class="tok-builtin">@compileError</span>(<span class="tok-str">&quot;expected key type to be `[]const u8`&quot;</span>);</span>
<span class="line" id="L469">            }</span>
<span class="line" id="L470"></span>
<span class="line" id="L471">            <span class="tok-kw">const</span> token = <span class="tok-kw">try</span> self.d.parser.nextAlloc(self.d.scratch.allocator(), .alloc_if_needed);</span>
<span class="line" id="L472"></span>
<span class="line" id="L473">            <span class="tok-kw">switch</span> (token) {</span>
<span class="line" id="L474">                <span class="tok-kw">inline</span> .string, .allocated_string =&gt; |slice| <span class="tok-kw">return</span> slice,</span>
<span class="line" id="L475">                .object_end =&gt; <span class="tok-kw">return</span> <span class="tok-null">null</span>,</span>
<span class="line" id="L476">                .end_of_document =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L477">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L478">            }</span>
<span class="line" id="L479">        }</span>
<span class="line" id="L480"></span>
<span class="line" id="L481">        <span class="tok-kw">fn</span> <span class="tok-fn">nextValueSeed</span>(self: *Self, arena: Allocator, seed: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L482">            <span class="tok-kw">return</span> <span class="tok-kw">try</span> seed.deserialize(arena, self.d.deserializer());</span>
<span class="line" id="L483">        }</span>
<span class="line" id="L484">    };</span>
<span class="line" id="L485">}</span>
<span class="line" id="L486"></span>
<span class="line" id="L487"><span class="tok-kw">fn</span> <span class="tok-fn">UnionAccess</span>(<span class="tok-kw">comptime</span> D: <span class="tok-type">type</span>) <span class="tok-type">type</span> {</span>
<span class="line" id="L488">    <span class="tok-kw">return</span> <span class="tok-kw">struct</span> {</span>
<span class="line" id="L489">        d: *D,</span>
<span class="line" id="L490"></span>
<span class="line" id="L491">        <span class="tok-kw">const</span> Self = <span class="tok-builtin">@This</span>();</span>
<span class="line" id="L492"></span>
<span class="line" id="L493">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> getty.de.UnionAccess(</span>
<span class="line" id="L494">            *Self,</span>
<span class="line" id="L495">            Err,</span>
<span class="line" id="L496">            .{</span>
<span class="line" id="L497">                .variantSeed = variantSeed,</span>
<span class="line" id="L498">            },</span>
<span class="line" id="L499">        );</span>
<span class="line" id="L500"></span>
<span class="line" id="L501">        <span class="tok-kw">pub</span> <span class="tok-kw">usingnamespace</span> getty.de.VariantAccess(</span>
<span class="line" id="L502">            *Self,</span>
<span class="line" id="L503">            Err,</span>
<span class="line" id="L504">            .{</span>
<span class="line" id="L505">                .payloadSeed = payloadSeed,</span>
<span class="line" id="L506">            },</span>
<span class="line" id="L507">        );</span>
<span class="line" id="L508"></span>
<span class="line" id="L509">        <span class="tok-kw">const</span> De = D.@&quot;getty.Deserializer&quot;;</span>
<span class="line" id="L510">        <span class="tok-kw">const</span> Err = De.Err;</span>
<span class="line" id="L511"></span>
<span class="line" id="L512">        <span class="tok-kw">fn</span> <span class="tok-fn">variantSeed</span>(self: *Self, arena: Allocator, seed: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L513">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.d.parser.peekNextTokenType()) {</span>
<span class="line" id="L514">                .string =&gt; <span class="tok-kw">try</span> seed.deserialize(arena, self.d.deserializer()),</span>
<span class="line" id="L515">                .end_of_document =&gt; <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L516">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L517">            };</span>
<span class="line" id="L518">        }</span>
<span class="line" id="L519"></span>
<span class="line" id="L520">        <span class="tok-kw">fn</span> <span class="tok-fn">payloadSeed</span>(self: *Self, arena: Allocator, seed: <span class="tok-kw">anytype</span>) Err!<span class="tok-builtin">@TypeOf</span>(seed).Value {</span>
<span class="line" id="L521">            <span class="tok-kw">const</span> payload = <span class="tok-kw">try</span> seed.deserialize(arena, self.d.deserializer());</span>
<span class="line" id="L522"></span>
<span class="line" id="L523">            <span class="tok-kw">return</span> <span class="tok-kw">switch</span> (<span class="tok-kw">try</span> self.d.parser.peekNextTokenType()) {</span>
<span class="line" id="L524">                .object_end =&gt; payload,</span>
<span class="line" id="L525">                .end_of_document =&gt; <span class="tok-kw">error</span>.UnexpectedEndOfInput,</span>
<span class="line" id="L526">                <span class="tok-kw">else</span> =&gt; <span class="tok-kw">error</span>.SyntaxError,</span>
<span class="line" id="L527">            };</span>
<span class="line" id="L528">        }</span>
<span class="line" id="L529">    };</span>
<span class="line" id="L530">}</span>
<span class="line" id="L531"></span>
<span class="line" id="L532"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">parseInt</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>, slice: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>) !T {</span>
<span class="line" id="L533">    <span class="tok-kw">return</span> std.fmt.parseInt(T, slice, <span class="tok-number">10</span>) <span class="tok-kw">catch</span> |err| <span class="tok-kw">switch</span> (err) {</span>
<span class="line" id="L534">        <span class="tok-kw">error</span>.InvalidCharacter =&gt; <span class="tok-kw">return</span> <span class="tok-kw">error</span>.InvalidType,</span>
<span class="line" id="L535">        <span class="tok-kw">error</span>.Overflow =&gt; <span class="tok-kw">return</span> err,</span>
<span class="line" id="L536">    };</span>
<span class="line" id="L537">}</span>
<span class="line" id="L538"></span>
<span class="line" id="L539"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">visitInt</span>(</span>
<span class="line" id="L540">    visitor: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L541">    arena: Allocator,</span>
<span class="line" id="L542">    <span class="tok-kw">comptime</span> De: <span class="tok-type">type</span>,</span>
<span class="line" id="L543">    slice: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L544">) !<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L545">    <span class="tok-kw">if</span> (<span class="tok-builtin">@typeInfo</span>(<span class="tok-builtin">@TypeOf</span>(visitor).Value) == .Int) {</span>
<span class="line" id="L546">        <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitIntHint(visitor, arena, De, slice);</span>
<span class="line" id="L547">    }</span>
<span class="line" id="L548"></span>
<span class="line" id="L549">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitIntBase(visitor, arena, De, slice);</span>
<span class="line" id="L550">}</span>
<span class="line" id="L551"></span>
<span class="line" id="L552"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">visitIntBase</span>(</span>
<span class="line" id="L553">    visitor: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L554">    arena: Allocator,</span>
<span class="line" id="L555">    <span class="tok-kw">comptime</span> De: <span class="tok-type">type</span>,</span>
<span class="line" id="L556">    slice: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L557">) !<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L558">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> <span class="tok-kw">switch</span> (slice[<span class="tok-number">0</span>]) {</span>
<span class="line" id="L559">        <span class="tok-str">'0'</span>...<span class="tok-str">'9'</span> =&gt; visitor.visitInt(arena, De, <span class="tok-kw">try</span> parseInt(<span class="tok-type">u128</span>, slice)),</span>
<span class="line" id="L560">        <span class="tok-kw">else</span> =&gt; visitor.visitInt(arena, De, <span class="tok-kw">try</span> parseInt(<span class="tok-type">i128</span>, slice)),</span>
<span class="line" id="L561">    };</span>
<span class="line" id="L562">}</span>
<span class="line" id="L563"></span>
<span class="line" id="L564"><span class="tok-kw">inline</span> <span class="tok-kw">fn</span> <span class="tok-fn">visitIntHint</span>(</span>
<span class="line" id="L565">    visitor: <span class="tok-kw">anytype</span>,</span>
<span class="line" id="L566">    arena: Allocator,</span>
<span class="line" id="L567">    <span class="tok-kw">comptime</span> De: <span class="tok-type">type</span>,</span>
<span class="line" id="L568">    slice: []<span class="tok-kw">const</span> <span class="tok-type">u8</span>,</span>
<span class="line" id="L569">) !<span class="tok-builtin">@TypeOf</span>(visitor).Value {</span>
<span class="line" id="L570">    <span class="tok-kw">const</span> Value = <span class="tok-builtin">@TypeOf</span>(visitor).Value;</span>
<span class="line" id="L571">    <span class="tok-kw">const</span> value_info = <span class="tok-builtin">@typeInfo</span>(Value);</span>
<span class="line" id="L572"></span>
<span class="line" id="L573">    <span class="tok-kw">if</span> (value_info.Int.signedness == .unsigned <span class="tok-kw">and</span> slice[<span class="tok-number">0</span>] == <span class="tok-str">'-'</span>) {</span>
<span class="line" id="L574">        <span class="tok-kw">return</span> <span class="tok-kw">error</span>.Overflow;</span>
<span class="line" id="L575">    }</span>
<span class="line" id="L576"></span>
<span class="line" id="L577">    <span class="tok-kw">return</span> <span class="tok-kw">try</span> visitor.visitInt(arena, De, <span class="tok-kw">try</span> parseInt(Value, slice));</span>
<span class="line" id="L578">}</span>
<span class="line" id="L579"></span>
<span class="line" id="L580"><span class="tok-kw">fn</span> <span class="tok-fn">isString</span>(<span class="tok-kw">comptime</span> T: <span class="tok-type">type</span>) <span class="tok-type">bool</span> {</span>
<span class="line" id="L581">    <span class="tok-kw">comptime</span> {</span>
<span class="line" id="L582">        <span class="tok-comment">// Only pointer types can be strings, no optionals</span>
</span>
<span class="line" id="L583">        <span class="tok-kw">const</span> info = <span class="tok-builtin">@typeInfo</span>(T);</span>
<span class="line" id="L584">        <span class="tok-kw">if</span> (info != .Pointer) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L585">        <span class="tok-kw">const</span> ptr = &amp;info.Pointer;</span>
<span class="line" id="L586"></span>
<span class="line" id="L587">        <span class="tok-comment">// Check for CV qualifiers that would prevent coerction to []const u8</span>
</span>
<span class="line" id="L588">        <span class="tok-kw">if</span> (ptr.is_volatile <span class="tok-kw">or</span> ptr.is_allowzero) <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L589"></span>
<span class="line" id="L590">        <span class="tok-comment">// If it's already a slice, simple check.</span>
</span>
<span class="line" id="L591">        <span class="tok-kw">if</span> (ptr.size == .Slice) {</span>
<span class="line" id="L592">            <span class="tok-kw">return</span> ptr.child == <span class="tok-type">u8</span>;</span>
<span class="line" id="L593">        }</span>
<span class="line" id="L594"></span>
<span class="line" id="L595">        <span class="tok-comment">// Otherwise check if it's an array type that coerces to slice.</span>
</span>
<span class="line" id="L596">        <span class="tok-kw">if</span> (ptr.size == .One) {</span>
<span class="line" id="L597">            <span class="tok-kw">const</span> child = <span class="tok-builtin">@typeInfo</span>(ptr.child);</span>
<span class="line" id="L598">            <span class="tok-kw">if</span> (child == .Array) {</span>
<span class="line" id="L599">                <span class="tok-kw">const</span> arr = &amp;child.Array;</span>
<span class="line" id="L600">                <span class="tok-kw">return</span> arr.child == <span class="tok-type">u8</span>;</span>
<span class="line" id="L601">            }</span>
<span class="line" id="L602">        }</span>
<span class="line" id="L603"></span>
<span class="line" id="L604">        <span class="tok-kw">return</span> <span class="tok-null">false</span>;</span>
<span class="line" id="L605">    }</span>
<span class="line" id="L606">}</span>
<span class="line" id="L607"></span>
</code></pre></body>
</html>